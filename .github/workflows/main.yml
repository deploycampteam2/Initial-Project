name: Deploy Streamlit (Improved) to VPS

on: [push]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Basic system info
        run: |
          echo "🎯 === IMPROVED STREAMLIT DEPLOYMENT ==="
          echo "📅 Date: $(date)"
          echo "👤 User: $(whoami)"
          echo "🖥️ Hostname: $(hostname)"
          echo "📂 Working Directory: $(pwd)"
          echo "🌐 Server IP: $(hostname -I | awk '{print $1}')"
          
      - name: Deploy application
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "🚀 === DEPLOYING STREAMLIT APP ==="
          
          # Navigate to home directory
          cd /home/ubuntu
          
          # Clean removal of existing project
          if [ -d "initial_project" ]; then
            echo "🧹 Removing existing project completely..."
            rm -rf initial_project
          fi
          
          # Clone repository to fresh directory
          echo "📥 Cloning repository to fresh directory..."
          git clone https://$GH_TOKEN@github.com/$GITHUB_REPOSITORY.git initial_project
          
          # Navigate to project directory
          cd initial_project
          
          echo "✅ Repository cloned successfully"
          echo "📋 Project structure:"
          ls -la
          echo "📋 Website folder contents:"
          if [ -d "website" ]; then
            ls -la website/
          else
            echo "⚠️ Website folder not found!"
          fi
          
      - name: Build and run Streamlit container (Improved)
        run: |
          echo "🐳 === IMPROVED DOCKER SETUP ==="
          cd /home/ubuntu/initial_project
          
          # Stop and remove ALL streamlit containers
          echo "🛑 Stopping all existing streamlit containers..."
          docker stop $(docker ps -q --filter "name=streamlit") 2>/dev/null || true
          docker rm $(docker ps -aq --filter "name=streamlit") 2>/dev/null || true
          
          # Clean up old images more thoroughly
          echo "🗑️ Cleaning up old images..."
          docker rmi streamlit-app 2>/dev/null || true
          docker system prune -f
          
          # Build new Docker image
          echo "🏗️ Building Docker image..."
          docker build -t streamlit-app . --no-cache
          
          # Run container with improved settings
          echo "🚀 Starting Streamlit container..."
          docker run -d \
            --name streamlit-simple \
            -p 80:8501 \
            -p 8501:8501 \
            --restart unless-stopped \
            --health-cmd="curl -f http://localhost:8501/ || exit 1" \
            --health-interval=30s \
            --health-timeout=10s \
            --health-retries=3 \
            streamlit-app
          
          # Wait for container to start
          echo "⏳ Waiting for container to initialize..."
          sleep 15
          
          # Check if container is running
          if docker ps | grep -q "streamlit-simple"; then
            echo "✅ Streamlit container is running!"
            echo "🌐 Primary access: http://$(hostname -I | awk '{print $1}')"
            echo "🌐 Alternative access: http://$(hostname -I | awk '{print $1}'):8501"
            echo "🏠 Local access: http://localhost"
          else
            echo "❌ Container failed to start"
            echo "📋 Container logs:"
            docker logs streamlit-simple
            exit 1
          fi
          
      - name: Comprehensive health check
        run: |
          echo "🔍 === COMPREHENSIVE HEALTH CHECK ==="
          
          # Check container status
          echo "📊 Container status:"
          docker ps | grep streamlit-simple
          
          # Check port bindings
          echo "🔌 Port bindings:"
          docker port streamlit-simple
          
          # Check container health
          echo "🏥 Container health:"
          docker inspect streamlit-simple --format='{{.State.Health.Status}}'
          
          # Test multiple access methods
          echo "🧪 Testing accessibility..."
          
          # Test port 80
          if curl -f -s http://localhost/ > /dev/null 2>&1; then
            echo "✅ Port 80: Accessible"
          else
            echo "❌ Port 80: Not accessible"
          fi
          
          # Test port 8501
          if curl -f -s http://localhost:8501/ > /dev/null 2>&1; then
            echo "✅ Port 8501: Accessible"
          else
            echo "❌ Port 8501: Not accessible"
          fi
          
          # Show recent logs
          echo "📋 Recent container logs:"
          docker logs --tail 15 streamlit-simple
          
          # Show listening ports
          echo "👂 Server listening ports:"
          sudo netstat -tulnp | grep -E ':80|:8501' || echo "No ports found listening"
          
          # Final status
          echo ""
          echo "🎉 Deployment Status: COMPLETED"
          echo "🌐 Access your Streamlit app at:"
          echo "   👉 http://$(hostname -I | awk '{print $1}')"
          echo "   👉 http://$(hostname -I | awk '{print $1}'):8501"
          echo ""
          echo "🔧 Debug commands:"
          echo "   docker logs streamlit-simple"
          echo "   docker exec -it streamlit-simple /bin/bash"
          echo "   curl -v http://localhost/"